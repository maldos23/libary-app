name: Deploy Quarkus to Compute Engine

on:
  push:
    branches: [ "main" ]
    paths:
      - "library-backend/**"
      - ".github/workflows/deploy-backend-gcp.yml"

env:
  REGION: us-central1
  IMAGE: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/library/library-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Valida la zona antes de intentar cualquier operaci√≥n en Compute Engine
      - name: Validate zone
        run: |
          gcloud compute zones describe ${{ secrets.VM_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --quiet > /dev/null
          echo "‚úÖ Zone ${{ secrets.VM_ZONE }} is valid"

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # Crea el repositorio de Artifact Registry si no existe
      - name: Create Artifact Registry repository (if needed)
        run: |
          gcloud artifacts repositories describe library \
            --location=${{ env.REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} 2>/dev/null \
          || gcloud artifacts repositories create library \
              --repository-format=docker \
              --location=${{ env.REGION }} \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --description="Library backend Docker images"

      - name: Build and Push Docker image
        run: |
          docker build \
            -t ${{ env.IMAGE }}:${{ github.sha }} \
            -t ${{ env.IMAGE }}:latest \
            ./library-backend
          docker push ${{ env.IMAGE }}:${{ github.sha }}
          docker push ${{ env.IMAGE }}:latest

      # Abre el puerto 8080 solo si la regla no existe todav√≠a
      - name: Create firewall rule (if needed)
        run: |
          gcloud compute firewall-rules describe allow-library-8080 \
            --project=${{ secrets.GCP_PROJECT_ID }} 2>/dev/null \
          || gcloud compute firewall-rules create allow-library-8080 \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --direction=INGRESS \
              --action=ALLOW \
              --rules=tcp:8080 \
              --source-ranges=0.0.0.0/0 \
              --target-tags=library-backend \
              --description="Allow port 8080 for library backend"

      # Crea la VM (e2-small, COS) solo en el primer deploy
      - name: Create VM (first deploy only)
        run: |
          if gcloud compute instances describe ${{ secrets.VM_NAME }} \
               --zone=${{ secrets.VM_ZONE }} \
               --project=${{ secrets.GCP_PROJECT_ID }} 2>/dev/null; then
            echo "VM ya existe, se omite la creaci√≥n"
          else
            gcloud compute instances create ${{ secrets.VM_NAME }} \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --zone=${{ secrets.VM_ZONE }} \
              --machine-type=e2-small \
              --image-family=cos-stable \
              --image-project=cos-cloud \
              --boot-disk-size=20GB \
              --tags=library-backend \
              --scopes=cloud-platform \
              --metadata=enable-oslogin=TRUE,google-logging-enabled=TRUE
            echo "Esperando a que la VM est√© lista..."
            sleep 30
          fi

      # Despliega el contenedor en la VM v√≠a SSH (funciona tanto para creaci√≥n como actualizaci√≥n)
      - name: Deploy container via SSH
        run: |
          gcloud compute ssh ${{ secrets.VM_NAME }} \
            --zone=${{ secrets.VM_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --quiet \
            --command="
              set -e
              # Autenticar Docker con Artifact Registry usando la SA de la VM
              gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

              # Detener y eliminar contenedor anterior si existe
              docker stop library-backend 2>/dev/null || true
              docker rm   library-backend 2>/dev/null || true

              # Crear directorio de datos persistente para SQLite
              mkdir -p /mnt/library-data

              # Descargar y ejecutar la nueva imagen
              docker pull ${{ env.IMAGE }}:${{ github.sha }}
              docker run -d \
                --name library-backend \
                --restart=always \
                -p 8080:8080 \
                -e PORT=8080 \
                -e DB_PATH=/data/library.db \
                -v /mnt/library-data:/data \
                ${{ env.IMAGE }}:${{ github.sha }}

              docker ps --filter name=library-backend --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
            "

      - name: Show external IP
        run: |
          IP=$(gcloud compute instances describe ${{ secrets.VM_NAME }} \
            --zone=${{ secrets.VM_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          echo "‚úÖ Deployed : ${{ env.IMAGE }}:${{ github.sha }}"
          echo "üåê External IP: ${IP}"
          echo "üîó API        : http://${IP}:8080/api/books"
